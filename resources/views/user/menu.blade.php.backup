<x-user-layout title="المنيو">
    <div class="max-w-7xl mx-auto">
        <!-- Page Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">المنيو</h1>
                    <p class="text-gray-600 mt-1">
                        @if(request('category'))
                        @php
                        $categoryName = $categories->find(request('category'))->name ?? 'الفئة المحددة';
                        $availableCount = $products->where('stock_quantity', '>', 0)->count();
                        @endphp
                        منتجات فئة {{ $categoryName }} - {{ $availableCount }} منتج متاح
                        @elseif(request('search'))
                        @php
                        $availableCount = $products->where('stock_quantity', '>', 0)->count();
                        @endphp
                        نتائج البحث عن "{{ request('search') }}" - {{ $availableCount }} منتج متاح
                        @else
                        @php
                        $availableCount = $products->where('stock_quantity', '>', 0)->count();
                        @endphp
                        تصفح جميع المنتجات المتاحة - {{ $availableCount }} منتج متاح
                        @endif
                    </p>
                </div>
                @if(request('category') || request('search'))
                <div class="flex items-center">
                    <a href="{{ route('menu.index') }}" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm hover:bg-gray-200 transition-colors">
                        <i class="fas fa-times mr-1"></i>
                        مسح الفلاتر
                    </a>
                </div>
                @endif
            </div>
        </div>

        <!-- Search Bar -->
        <x-user.search-bar page="menu" />

        <!-- Categories Filter -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="p-4">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">الفئات</h3>
                <div class="flex flex-wrap gap-2">
                    <a href="{{ route('menu.index') }}" class="px-4 py-2 {{ !request('category') ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }} rounded-full text-sm font-medium transition-colors">
                        الكل
                    </a>
                    @forelse($categories as $category)
                    <a href="{{ route('menu.index', ['category' => $category->id]) }}" class="px-4 py-2 {{ request('category') == $category->id ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }} rounded-full text-sm font-medium transition-colors">
                        <i class="fas fa-tag mr-1"></i>
                        {{ $category->name }}
                    </a>
                    @empty
                    <span class="text-gray-500 text-sm">لا توجد فئات متاحة</span>
                    @endforelse
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
            @forelse($products->where('stock_quantity', '>', 0) as $product)
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative group transition hover:shadow-md h-[500px] max-h-[500px]">
                <!-- Product Image -->
                <div class="relative w-full bg-blue-50/40 aspect-square flex-shrink-0">
                    @if($product->image)
                    <img src="{{ asset('storage/' . $product->image) }}" alt="{{ $product->name }}" class="w-full h-full object-cover object-center">
                    @else
                    <div class="w-full h-full flex items-center justify-center text-gray-300 bg-gradient-to-br from-blue-400 to-blue-600">
                        <i class="fas fa-{{ $product->getIconClass() }} text-white text-6xl"></i>
                    </div>
                    @endif

                    <!-- Tags Container (Top Left) -->
                    <div class="absolute top-3 left-3 flex flex-col gap-2 z-10">
                        <!-- Weekly Product Badge -->
                        @if($product->type === 'weekly')
                        <span class="bg-purple-100 text-purple-700 text-xs font-semibold px-3 py-1 rounded-full border border-purple-300">
                            <i class="fas fa-star mr-1"></i>
                            منتج الأسبوع
                        </span>
                        @endif

                        <!-- Low Stock Badge -->
                        @if($product->stock_quantity <= 3 && $product->stock_quantity > 0)
                            <span class="bg-orange-100 text-orange-700 text-xs font-semibold px-3 py-1 rounded-full border border-orange-300">
                                <i class="fas fa-exclamation-triangle mr-1 text-orange-500"></i>
                                قرب يخلّص
                            </span>
                            @endif
                    </div>
                </div>

                <!-- Product Content -->
                <div class="flex-1 flex flex-col p-4 gap-2 overflow-y-auto">
                    <h3 class="text-base font-extrabold text-gray-900 mb-1">{{ $product->name }}</h3>

                    @if($product->description)
                    <p class="text-xs text-gray-500 mb-2 line-clamp-2">{{ Str::limit($product->description, 80) }}</p>
                    @endif

                    <!-- Price Info -->
                    <div class="flex items-center flex-wrap gap-2 mb-1">
                        <span class="text-green-700 font-bold text-lg">{{ number_format($product->price, 2) }} ر.س</span>
                    </div>

                    <!-- Calories and Walking Time -->
                    @if($product->calories || $product->walking_time)
                    <div class="flex items-center gap-4 mb-2">
                        @if($product->calories)
                        <div class="flex items-center gap-1">
                            <i class="fas fa-fire text-orange-500 text-sm"></i>
                            <span class="text-xs text-gray-600">{{ $product->calories }} سعرة</span>
                        </div>
                        @endif

                        @if($product->walking_time)
                        <div class="flex items-center gap-1">
                            <i class="fas fa-walking text-blue-500 text-sm"></i>
                            <span class="text-xs text-gray-600">{{ $product->walking_time }} دقيقة مشي</span>
                        </div>
                        @endif
                    </div>
                    @endif

                    <!-- Action Buttons -->
                    <div class="mt-auto flex items-center gap-2 pt-3 flex-shrink-0 border-t border-gray-100">
                        <div class="flex w-full pt-2">
                            @auth
                            <button onclick="addToCart({{ $product->id }}, event)" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-center py-2 rounded-xl font-bold text-xs transition shadow-sm flex items-center justify-center">
                                <i class="fas fa-cart-plus ml-1"></i>
                                إضافة للسلة
                            </button>
                            @else
                            <a href="{{ route('login') }}" class="w-full bg-gray-400 hover:bg-gray-500 text-white text-center py-2 rounded-xl font-bold text-xs transition shadow-sm flex items-center justify-center">
                                <i class="fas fa-sign-in-alt ml-1"></i>
                                تسجيل دخول
                            </a>
                            @endauth
                        </div>
                    </div>
                </div>
            </div>
            @empty
            <!-- Empty State -->
            <div class="col-span-full">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
                    <div class="max-w-md mx-auto">
                        <i class="fas fa-coffee text-6xl text-gray-300 mb-4"></i>
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">
                            @if(request('category'))
                            لا توجد منتجات متاحة في هذه الفئة
                            @elseif(request('search'))
                            لم يتم العثور على نتائج متاحة
                            @else
                            لا توجد منتجات متاحة حالياً
                            @endif
                        </h2>
                        <p class="text-gray-500 mb-4">
                            @if(request('category') || request('search'))
                            جرب البحث في فئة أخرى أو قم بمسح الفلاتر
                            @else
                            جميع المنتجات نفدت أو سيتم إضافة منتجات جديدة قريباً
                            @endif
                        </p>
                        @if(request('category') || request('search'))
                        <a href="{{ route('menu.index') }}" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition-colors font-semibold">
                            مسح الفلاتر
                        </a>
                        @endif
                    </div>
                </div>
            </div>
            @endforelse
        </div>

        <!-- Pagination -->
        @if($products->hasPages())
        <div class="flex justify-center">
            {{ $products->appends(request()->query())->links() }}
        </div>
        @endif
    </div>
</x-user-layout>

<script>
    function addToCart(productId, event) {
        event.preventDefault();

        // Show loading indicator on button
        const button = event.target.closest('button');
        if (!button) return;

        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin ml-1"></i> جاري الإضافة...';
        button.disabled = true;

        // Get CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (!csrfToken) {
            showMessage('خطأ في الأمان: توكن CSRF غير موجود', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
            return;
        }

        fetch(`/cart/add/${productId}`, {
                method: 'POST'
                , headers: {
                    'Content-Type': 'application/json'
                    , 'X-CSRF-TOKEN': csrfToken.getAttribute('content')
                    , 'Accept': 'application/json'
                }
                , body: JSON.stringify({
                    quantity: 1
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `HTTP error! Status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Product added successfully:', data.product_name);
                    
                    // Update cart count immediately (before everything else)
                    incrementCartBadge(1);
                    
                    // Add animation effect to the cart icon in header
                    animateCartIcon();
                    
                    // Show success message
                    showMessage(`تم إضافة ${data.product_name} إلى السلة`, 'success');
                    
                    // Sync cart count with server in background
                    updateCartCount();
                } else {
                    console.log('Failed to add product:', data.message);
                    showMessage(data.message || 'حدث خطأ أثناء إضافة المنتج', 'error');
                }

                // Restore button
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage(error.message || 'حدث خطأ أثناء إضافة المنتج للسلة', 'error');

                // Restore button
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    // Increment cart badge immediately without waiting for server
    function incrementCartBadge(delta) {
        const cartBadge = document.querySelector('.cart-badge');
        if (!cartBadge) return;
        
        const current = parseInt(cartBadge.textContent, 10);
        const next = (isNaN(current) ? 0 : current) + (delta || 0);
        
        // Add scale animation for more visibility
        cartBadge.style.transform = 'scale(1.3)';
        cartBadge.style.transition = 'all 0.3s ease';
        cartBadge.classList.add('animate-pulse');
        
        // Update the number
        cartBadge.textContent = next;
        
        // Return to normal size
        setTimeout(() => {
            cartBadge.style.transform = 'scale(1)';
            cartBadge.classList.remove('animate-pulse');
        }, 300);
    }

    function updateCartCount() {
        fetch('/cart/count')
            .then(response => response.json())
            .then(data => {
                // Update cart badge in header
                const cartBadge = document.querySelector('.cart-badge');
                if (cartBadge) {
                    cartBadge.textContent = data.count;
                }
            })
            .catch(error => {
                console.error('Error updating cart count:', error);
            });
    }

    function showMessage(message, type) {
        // Create a simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#10b981' : '#ef4444'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-width: 90vw;
            text-align: center;
        `;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }

    function animateCartIcon() {
        const cartIcon = document.querySelector('.cart-icon');
        if (cartIcon) {
            cartIcon.classList.add('animate-bounce');
            setTimeout(() => {
                cartIcon.classList.remove('animate-bounce');
            }, 1000);
        }
    }

</script>
